{% extends 'base.html.twig' %}
{% form_theme formpedidoaddress 'bootstrap_3_layout.html.twig' %}
 {% form_theme form 'bootstrap_3_layout.html.twig' %}
{% block body %}
    <div class="row">
       <input id="nro_pedido" type="hidden" value="{{pedido.id}}"/>  
    	<div class="col-xs-12 col-sm-4">
            <div class="panel panel-default small">
            <div class="panel-heading"> <b>Pedido</b></div>
            <div class="panel-body">
            
                   <table class="table ">
                       <tr><th>ID:</th><td>{{pedido.id}}</td></tr>
                       <tr><th>Usuario/Cliente:</th><td> {{pedido.user.textocombo}}</td></tr>
                       <tr><th>Fecha:</th><td>    {{pedido.fecha|date('d/m/Y H:i:s')}}</td></tr>
                       <tr><th>Estado:</th><td>   {{estados[pedido.estadoId]}}</td></tr>
                   
                   </table>
                    
                    {% if pedido.estadoId == PENDIENTE %}
                        {{ form_start(formchangestatus) }}
                                <input type="submit" value="Cambiar estado a EN PREPARACION"  class="btn btn-flat btn-warning">
                        {{ form_end(formchangestatus) }}
                    {% endif %}
                    
                    {% if pedido.estadoId == ENPREPARACION %}
                        {{ form_start(formchangestatus) }}
                                <input type="submit" value="Cambiar estado a EN CAMINO"  class="btn btn-flat btn-warning">
                        {{ form_end(formchangestatus) }}
                    {% endif %}
                    
                    {% if pedido.estadoId == ENCAMINO %}
                        {{ form_start(formchangestatus) }}
                                <input type="submit" value="Cambiar estado a ENTREGADO"  class="btn btn-flat btn-success">
                        {{ form_end(formchangestatus) }}
                    {% endif %}
               </div>
            </div>
        </div>
        
        <div class="col-xs-12 col-sm-8">
    
            <div class="panel panel-default small">
            <div class="panel-heading"> <b>Detalle del pedido:</b></div>
            <div class="panel-body">
            <div class="row">
                    <div class="row">
                       <div class="col-xs-12"> 
                       
                       <div name="alert" class="alert alert-success alert-dismissable" style="display:none">
                            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                               Cantidad Actualizada Correctamente
                       </div>
                       </div>
                    </div>
                       
                       
                    <table class="datatable">
                                    
                        <thead>
                            <th>Nro Pote</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Acciones</th>
                            
                        </thead>
                        <tbody>
                            
                            {% for item in pedidodetalles|sort %}
                            <tr>
                                <form>
                                    <td>{{item.nropote}}</td>
                                    <td >{{item.producto.nombre}}</td>
                                    <td>{{item.cantidadstring }}</td>
                                    <!--
                                    <td class="col-md-2">
                                        <input disabled name="cantidad" class="form-control" data-id="{{item.id}}" value="{{item.cantidadstring }}">
                                        <div class="btn btn-xs btn-default actualizaritempedido" data-id="{{item.id}}">Actualizar </div> 
                                    </td>
                                    -->
                                
                                    <td><a href="{{ path('pedidodetalle_delete', {'id':item.id}) }}" class="label label-danger"><span class="glyphicon glyphicon-remove"></span></a></td>
                                </form>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                
             </div>
             </div>
             </div>
     	</div>
        
        
    </div>

    
   
    <div class="row">
    
    
    <div class="col-xs-12 col-sm-4">
  			<img src="{{asset('img/2.gif') }}" style="display:none" id="gif_saving_1" >
            <div class="panel panel-default small" 
            	 id="pnl_datos_entrega">
            <div class="panel-heading"> <b>Datos de Entrega</b></div>
            <div class="panel-body">
              			<div class="gif_saving" ></div>

                       {{ form_start(formpedidoaddress) }}
                         {{ form_widget(formpedidoaddress) }}
            			 <div id="btn_actualizar_datos_entrega" class="btn btn-info" ><i class="glyphicon glyphicon-refresh"></i> Actualizar Datos de Entrega </div>
                       {{ form_end(formpedidoaddress) }}
     
               </div>
            </div>
        </div>
        
        <div class="col-xs-12 col-sm-4">
	        <img src="{{asset('img/2.gif') }}" style="display:none" id="gif_saving_monto" >
            <div class="panel panel-default small" id="pnl_datos_montos">
            <div class="panel-heading"> <b>Cantidades Y Monto</b></div>
            <div class="panel-body">
            
                       {{ form_start(formpedidomontos) }}
                         {{ form_widget(formpedidomontos) }}
            			 <div id="btn_actualizar_montos" class="btn btn-info" > <i class="glyphicon glyphicon-refresh"></i> Actualizar </div>
                       {{ form_end(formpedidomontos) }}
                    
               </div>
            </div>
        </div>
        
        
    
     	<div class="col-xs-12 col-sm-4">      
            <div class="panel panel-default small">
            <div class="panel-heading"> <b>Agregar Producto:</b></div>
            <div class="panel-body">
               
                {{ form_start(form) }}
                    {{ form_widget(form) }}
                    <input class="btn btn-primary" type="submit" value="Agregar Producto"> </>
                    <a href="{{ path('pedido_index')}}" class="btn btn-default">Volver al Listado</a>
                {{ form_end(form) }}
                
            </div>
            </div>
    	</div>	
    </div>
    
    
    
    
    
    
    
    <script>
       jQuery(document).ready(function($)
       {
			//ACTUALIZARA DATOS DE ENTREGA DEL PEDIDO
			var    	   panel     = $("#pnl_datos_entrega");

			$("#btn_actualizar_datos_entrega").click(function(){
				panel     = $("#pnl_datos_entrega");
				loader    = $("#gif_saving_1");
				effectOk(panel,loader);
				id  	  = $("#nro_pedido").val();
				contacto  = $("#appbundle_Pedido_contacto").val();
	            localidad = $("#appbundle_Pedido_localidad").val();
	            calle     = $("#appbundle_Pedido_calle").val();
	            piso      = $("#appbundle_Pedido_piso").val();
	            nro 	  = $("#appbundle_Pedido_nro").val();
	        	telefono  = $("#appbundle_Pedido_telefono").val();
	            var json_data = {'pedido':{
		            					'id':id,
	                					'contacto':contacto,
	                					'localidad':localidad,
	                					'calle':calle,
	                					'piso':piso,
	                					'nro':nro,
	                					'telefono':telefono
	                					}
								};
	            $.ajax({
	                   method: "POST",
	                   url: "/api/pedido/updateaddress",
	                   dataType: 'json',
                       data: JSON.stringify( json_data ),
	                   success: function(data)
	                   {
	                       if(data.hasOwnProperty("code") )
	                       {
			                    if (data.code==200){
			                    	
				                }  
	                       }
	                   },
        	            error: function(jqXHR, textStatus, errorThrown )
                        {
                            alert(jqXHR.responseText);
                        }
	           		});
				});
				//FIN ACTUALIZAR DATOS DE ENTREGA


    	   

			//ACTUALIZAR DATOS MONTOS
			panel     = $("#pnl_datos_montos");
			$("#btn_actualizar_montos").click(function(){
				loader    = $("#gif_saving_monto");
				effectOk(panel,loader);
				
				id  	  	      = $("#nro_pedido").val();
				cantidadkilos     = $("#appbundle_Pedido_cantidadkilos").val();
				cantidadpotes     = $("#appbundle_Pedido_cantidadpotes").val();
	            cucharitas        = $("#appbundle_Pedido_cucharitas").val();
	            cucuruchos        = $("#appbundle_Pedido_cucuruchos").val();
	            montocucuruchos   = $("#appbundle_Pedido_montocucuruchos").val();
	            montohelados      = $("#appbundle_Pedido_montohelados").val();
	            montodescuento    = $("#appbundle_Pedido_montodescuento").val();
	            enviodomicilio    = $("#appbundle_Pedido_enviodomicilio").val();
	            monto    = $("#appbundle_Pedido_monto").val();

	            var json_data   = {'pedido':{
		            			 		'id':id,
	                					'cantidadkilos':cantidadkilos,
	                					'cantidadpotes':cantidadpotes,
	                					'cucharitas':cucharitas,
	                					'cucuruchos':cucuruchos,
	                					'montocucuruchos':montocucuruchos,
	                					'montohelados':montohelados,
	                					'montodescuento':montodescuento,
	                					'enviodomicilio':enviodomicilio,
	                					'monto':monto,
	                					}
								};
	            $.ajax({
	                   method: "POST",
	                   url: "/api/pedido/updatemontos",
	                   dataType: 'json',
                       data: JSON.stringify( json_data ),
	                   success: function(data)
	                   {
	                       if(data.hasOwnProperty("code") )
	                       {
			                    if (data.code==200){
			                    	
				                }  
	                       }
	                   },
        	            error: function(jqXHR, textStatus, errorThrown )
                        {
                            alert(jqXHR.responseText);
                        }
	           		});
				});


			
   			




			
		});

       </script>
     
{% endblock %}




{% block javascripts %}
    <script>
        jQuery(document).ready(function($)
        {
            
            /*Detectar evento click */
            $(".btn.btn-xs.btn-default.actualizaritempedido").click(function(){

                    //Armar json
                    var id = $(this).attr("data-id");
                    var select = "input[data-id=" + id + "][name='cantidad']";
                    var cantidad = $(select).val();
                    var json_item = {
                                    "id": id,
                                    "cantidad": cantidad
                                    };
                        
                        $.ajax({
                            method: "POST",
                            url: "/api/pedidodetalle/edit",
                            dataType: 'json',
                            data: JSON.stringify( json_item ),
                            success: function(data)
                            {
                                if(data.hasOwnProperty("code") && data.code === 200)
                                {
                                    alert("Cantidad Actualizada Correctamente...");
                                    //var msg = $("div[name='alert']");
                                    var monto = $("td[data-id=" + id + "][name='monto']");
                                    importe = data.data.cantidad;// * data.data.preciounitario;
                                    monto.html(importe);
                                }
                            },
                            error: function(jqXHR, exception)
                            {
                                if(jqXHR.status === 405)
                                {
                                    console.error("METHOD NOT ALLOWED!");
                                }
                            }
                    });

                        
                        
            });
            
            
        });
    </script>
{% endblock %}